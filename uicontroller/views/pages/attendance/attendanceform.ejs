<%- include('../../partials/header.ejs', { isMenuVisible : true, title: 'Attendance' }) %>
    <h2 class="text-center mb-4">Attendance Form</h2>
    <div class="row justify-content-center">
        <div class="col-md-3">
            <div class="form-group">
                <label for="blockCode">Block Code</label>
                <select class="form-control" id="blockCode"></select>
            </div>
            <div class="form-group">
                <label for="floorNumber">Floor Number</label>
                <select class="form-control" id="floorNumber"></select>
            </div>
            <div class="form-group">
                <label for="roomNumber">Room Number</label>
                <select class="form-control" id="roomNumber"></select>
            </div>
            <div class="form-group">
                <label for="checkIn">Check-in Date</label>
                <input type="date" class="form-control" id="checkIn">
            </div>
            <div class="form-group">
                <label for="studentList">Students</label>
                <ul id="studentList" class="list-group"></ul>
            </div>
            <div class="text-center">
                <input type="hidden" id="attendanceId" value="<%=attendanceId %>" />
                <button type="button" onclick="saveOrUpdateAttendance()" class="btn btn-success" id="submitButton"
                    disabled>Submit</button>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer.ejs') %>
        <script>
            var blockCode = document.getElementById('blockCode');
            var floorNumber = document.getElementById('floorNumber');
            var roomNumber = document.getElementById('roomNumber');
            var checkIn = document.getElementById('checkIn');
            var attendanceStatus = document.querySelector('input[name="isPresent"]');
            var studentList = document.getElementById('studentList');
            var submitButton = document.getElementById('submitButton');
            var attendanceId = document.getElementById('attendanceId').value;
            const today = new Date().toISOString().split('T')[0];
            checkIn.value = today;

            function getSelectedStatus() {
                let attendanceStatusValue = null;
                attendanceStatus.forEach(radio => {
                    if (radio.checked) {
                        attendanceStatusValue = parseInt(radio.value);
                    }
                });
                return attendanceStatusValue;
            }

            async function populateStudentList() {
                try {
                    const response = await fetch('http://localhost:1000/api/student?blockId=' + blockCode.value + '&floorNumber=' + floorNumber.value + '&roomId=' + roomNumber.value);
                    const students = await response.json();

                    studentList.innerHTML = '';
                    students.forEach(student => {
                        const li = document.createElement('li');
                        li.classList.add('list-group-item');
                        li.innerHTML = `
                    <span>${student.name}</span>
                    <div class="form-check float-right">
                        <input class="form-check-input" type="radio" name="isPresent" value="1" id="present_${student.studentId}">
                        <label class="form-check-label" for="present_${student.studentId}">Present</label>
                        <input class="form-check-input ml-2" type="radio" name="isPresent" value="0" id="absent_${student.studentId}">
                        <label class="form-check-label" for="absent_${student.studentId}">Absent</label>
                    </div>`;
                        studentList.appendChild(li);
                    });
                } catch (error) {
                    console.log('Error fetching student list:', error);
                }
            }

            function saveOrUpdateAttendance() {
                const isPresentValue = getSelectedStatus();
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var raw = JSON.stringify({
                    "blockId": blockCode.value,
                    "blockFloorId": floorNumber.value,
                    "roomId": roomNumber.value,
                    "checkInDate": checkIn.value,
                    "isPresent": isPresentValue
                });

                var requestOptions = {
                    method: attendanceId ? 'PUT' : 'POST',
                    headers: myHeaders,
                    body: raw
                };

                let url = "http://localhost:1000/api/attendance";
                if (attendanceId) {
                    url = url + '/' + attendanceId
                }

                fetch(url, requestOptions)
                    .then(response => response.text())
                    .then(attendances => window.location = '/attendance')
                    .catch(error => console.error('error', error));
            }

            function toggleSubmitButton() {
                const attendanceStatusValue = getSelectedStatus();
                submitButton.disabled = !(
                    blockCode.value !== 'Select' &&
                    floorNumber.value !== 'Select' &&
                    roomNumber.value !== 'Select' &&
                    checkIn.value !== '' &&
                    attendanceStatusValue !== null
                )
            }

            async function initializeForm() {
                await populateBlockCode();
                await populateFloorNumber();
                await populateRoomNumber()

                if (attendanceId) {
                    await getAttendanceById(attendanceId);
                }

                async function populateBlockCode() {
                    try {
                        const response = await fetch('http://localhost:1000/api/block');
                        const responseData = await response.json();
                        const { blocks } = responseData;

                        let optionsList = '<option selected>Select</option>';
                        blocks.forEach(block => {
                            optionsList += `<option value="${block.blockId}">${block.blockCode}</option>`;
                        });
                        blockCode.innerHTML = optionsList;
                    } catch (error) {
                        console.log('Error fetching block codes:', error);
                    }
                }

                async function populateFloorNumber() {
                    try {
                        const response = await fetch("http://localhost:1000/api/blockfloor")
                        const responseData = await response.json();
                        const { blockFloors } = responseData
                        var optionsList = '<option selected>Select</option>'
                        blockFloors.forEach(blockFloor => {
                            optionsList += `<option value="${blockFloor.blockFloorId}">${blockFloor.floorNumber}</option>`
                        })
                        floorNumber.innerHTML = optionsList
                    } catch (error) {
                        console.log('Error fetching floor Number:', error);
                    }
                }

                async function populateRoomNumber() {
                    try {
                        const response = await fetch("http://localhost:1000/api/room")
                        const responseData = await response.json()
                        const { rooms } = responseData
                        var optionsList = '<option selected>Select</option>'
                        rooms.forEach(room => {
                            optionsList += `<option value="${room.roomId}">${room.roomNumber}</option>`
                        })
                        roomNumber.innerHTML = optionsList
                    } catch (error) {
                        console.log('Error fetching room Number:', error);
                    }
                }

                roomNumber.addEventListener('input', toggleSubmitButton);
                floorNumber.addEventListener('input', toggleSubmitButton);
                blockCode.addEventListener('input', toggleSubmitButton);
                checkIn.addEventListener('input', toggleSubmitButton);
                isPresent.addEventListener('input', toggleSubmitButton);

                async function getAttendanceById(studentId) {
                    try {
                        const response = await fetch("http://localhost:1000/api/attendance/" + attendanceId);
                        const attendance = await response.json();
                        studentName.value = attendance.studentId
                        roomNumber.value = attendance.roomId
                        floorNumber.value = attendance.blockFloorId
                        blockCode.value = attendance.blockId
                        checkIn.value = attendance.checkInDate.split('T')[0]
                        if (attendance.isPresent) {
                            document.getElementById('present').checked = true;
                        } else {
                            document.getElementById('absent').checked = true;
                        }
                    } catch (error) {
                        console.error('Error fetching Attendance details:', error);
                    }
                }
            }

            initializeForm();
        </script>