<%- include('../partials/header.ejs', { isMenuVisible : false, title: 'ResetPassword' , breadcrumb: []}) %>
    <form class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-4">
                <div class="border">
                    <form>
                        <h3 class="font-weight-bold text-center mb-3">Forgotten Password ?</h3>
                        <div id="emailValid">
                            <div class="mb-3">
                                <label for="emailId" class="form-label">Email</label>
                                <input type="text" class="form-control" id="emailId" placeholder="Enter email"
                                    aria-describedby="emailHelp" onkeyup="toggleButton()">
                                <small id="emailError" class="errorContent"></small>
                            </div>
                            <div class="col d-flex justify-content-center mb-2">
                                <button type="button" class="btn btn-primary" id="sendOtp" onclick="generateOtp()"
                                    disabled>Generate OTP</button>
                            </div>
                        </div>
                        <div id="additionalFields" class="hidden">
                            <b class="fs-6">Please enter the 6-digit code sent to your email.</b>
                            <div class="mb-3">
                                <label for="otp" class="form-label">OTP</label>
                                <input type="text" class="form-control" id="otp" onkeyup="toggleButton()"
                                    placeholder="Enter OTP">
                                <small id="otpError" class="errorContent"></small>
                            </div>
                            <div class="col d-flex justify-content-center mb-2">
                                <button type="button" class="btn btn-primary" id="resendOtp"
                                    onclick="generateOtp()">Resend OTP</button>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" onkeyup="toggleButton()"
                                    placeholder="Enter password">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="confirmPassword"
                                    placeholder="Enter confirm password" onkeyup="toggleButton()">
                                <small id="passwordError" class="errorContent"></small>
                            </div>
                            <div class="col d-flex justify-content-center mb-2">
                                <button type="button" class="btn btn-primary" id="submit" onclick="resetPassword()"
                                    disabled>Verify
                                    OTP & SavePassword</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script>
            var emailId = document.getElementById('emailId');
            var sendOtp = document.getElementById('sendOtp');
            var additionalFields = document.getElementById('additionalFields');
            var otp = document.getElementById('otp');
            var password = document.getElementById('password');
            var confirmPassword = document.getElementById('confirmPassword');
            var emailValid = document.getElementById('emailValid');
            var emailError = document.getElementById('emailError');
            var otpError = document.getElementById('otpError');
            var submit = document.getElementById('submit');

            function toggleButton() {
                sendOtp.disabled = !(emailId.value.length > 0)
                submit.disabled = !(
                    otp.value.length > 0 &&
                    password.value === confirmPassword.value
                )
            }

            function generateOtp() {
                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var raw = JSON.stringify({
                    "emailId": emailId.value
                });

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                };

                fetch("http://localhost:1000/api/warden/generateOtp", requestOptions)
                    .then(async (response) => {
                        if (response.status === 200) {
                            emailValid.style.display = 'none'
                            additionalFields.style.display = 'block'
                        } else {
                            if (response.status === 401) {
                                alert(await response.text())
                            } else {
                            emailError.innerText = 'Please provide valid Email.'
                            emailError.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => console.log('error', error));

            }

            function resetPassword() {

                var myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");

                var raw = JSON.stringify({
                    "otp": otp.value,
                    "password": password.value
                });

                var requestOptions = {
                    method: 'PUT',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                };

                fetch("http://localhost:1000/api/warden/validateOtp/newPassword", requestOptions)
                    .then(async (response) => {
                        if (response.status === 200) {
                            window.location = '/login'
                        } else {
                            if (response.status === 401) {
                            alert(await response.text())
                            } else {
                            otpError.innerText = 'Invalid OTP. Please try again.'
                            return otpError.style.display = 'block'
                            }

                            if (response.status === 400) {
                            passwordError.innerText = 'Invalid password minimum 6 characters required'
                            passwordError.style.display = 'block'
                            }
                                // alert(await response.text())
                            }
                    })
                    .catch(error => console.log('error', error));
            }

            emailId.addEventListener('input', function () {
                emailError.style.display = 'none';
            });

            otp.addEventListener('input', function () {
                otpError.style.display = 'none';
            });

            password.addEventListener('input', function () {
                passwordError.style.display = 'none';
            });

            confirmPassword.addEventListener('input', function () {
                passwordError.style.display = 'none';
            });

        </script>
        <%- include('../partials/footer.ejs') %>